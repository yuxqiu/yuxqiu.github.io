<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta name="view-transition" content="same-origin"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="author" content="Yuxiang Qiu"> <title>TIL-6 | Yuxiang Qiu</title> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="TIL-6"> <meta property="og:locale" content="en"> <meta name="description" content="Why does calloc exist?"> <meta property="og:description" content="Why does calloc exist?"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2023/til-6/"> <meta property="og:url" content="https://yuxqiu.github.io/blog/2023/til-6/"> <meta property="og:site_name" content="Yuxiang Qiu"> <meta property="og:image" content="https://yuxqiu.github.io/assets/img/og/posts/til-6.png"> <meta property="og:image:height" content="600"> <meta property="og:image:width" content="1200"> <meta property="og:image:alt" content="TIL-6"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2023-01-07T19:42:06+00:00"> <meta name="twitter:card" content="summary_large_image"> <meta property="twitter:image" content="https://yuxqiu.github.io/assets/img/og/posts/til-6.png"> <meta name="twitter:image:alt" content="TIL-6"> <meta property="twitter:title" content="TIL-6"> <meta name="twitter:site" content="@yuxqiu"> <meta name="google-site-verification" content="OyP7PF7v8xjEbPqbdYaMosljunIcAOjdw_C6-TtA8f0"> <meta name="msvalidate.01" content="231286930EDC7A744F88D1D05B1BD04A"> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-02-18T14:33:14+00:00","datePublished":"2023-01-07T19:42:06+00:00","description":"Why does calloc exist?","headline":"TIL-6","image":{"width":1200,"height":600,"alt":"TIL-6","url":"https://yuxqiu.github.io/assets/img/og/posts/til-6.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yuxqiu.github.io/blog/2023/til-6/"},"url":"https://yuxqiu.github.io/blog/2023/til-6/"}</script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="/assets/css/mdb.min.css?62a43d1430ddb46fc4886f9d0e3b49b8"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2023/til-6/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class=" "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yuxiang Qiu </a> <input type="checkbox" id="navbar-toggler-checkbox" class="navbar-toggler-checkbox" hidden> <label for="navbar-toggler-checkbox" class="navbar-toggler ml-auto"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </label> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/ss/index.html">SS </a> </li> <li class="nav-item "> <a class="nav-link" href="/now/">Now </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <svg id="light-toggle-system" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9.173 14.83a4 4 0 1 1 5.657 -5.657"></path><path d="M11.294 12.707l.174 .247a7.5 7.5 0 0 0 8.845 2.492a9 9 0 0 1 -14.671 2.914"></path><path d="M3 12h1"></path><path d="M12 3v1"></path><path d="M5.6 5.6l.7 .7"></path><path d="M3 21l18 -18"></path></svg> <svg id="light-toggle-dark" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341 -.82 -.476 -1.644 -1.298 -1.31a6.5 6.5 0 0 1 -6.864 -10.787l.077 -.08c.551 -.63 .113 -1.653 -.758 -1.653h-.266l-.068 -.006l-.06 -.002z"></path></svg> <svg id="light-toggle-light" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 19a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M18.313 16.91l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.218 -1.567l.102 .07z"></path><path d="M7.007 16.993a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M6.213 4.81l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.217 -1.567l.102 .07z"></path><path d="M19.107 4.893a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M12 7a5 5 0 1 1 -4.995 5.217l-.005 -.217l.005 -.217a5 5 0 0 1 4.995 -4.783z"></path></svg> </button> </li> </ul> </div> </div> </nav> </header> <main class="container mt-5 flex-grow-1" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">TIL-6</h1> </header> <article class="post-content"> <hr> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#why-does-calloc-exist">Why does calloc exist?</a></li> <li class="toc-entry toc-h2"><a href="#c-standard-parallelism">C++ Standard Parallelism</a></li> <li class="toc-entry toc-h2"><a href="#empty-base-optimization">Empty Base Optimization</a></li> <li class="toc-entry toc-h2"><a href="#trivia">Trivia</a></li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="why-does-calloc-exist"><a href="https://vorpus.org/blog/why-does-calloc-exist/" rel="external nofollow noopener" target="_blank">Why does calloc exist?</a></h2> <p>Explain the reasoning behind the <code class="language-plaintext highlighter-rouge">calloc</code> function in C. The use of <code class="language-plaintext highlighter-rouge">calloc</code> ensures the allocated memory is zeroed. Compared with the <code class="language-plaintext highlighter-rouge">malloc</code> + <code class="language-plaintext highlighter-rouge">memset</code> method, <code class="language-plaintext highlighter-rouge">calloc</code> offers overflow checking and is more efficient than the <code class="language-plaintext highlighter-rouge">malloc</code> because it relies on the fact that 1) new memory returned from OS is zeroed and 2) the actual memory allocation (page fault) is delayed until the application starts to access the memory.</p> <h2 id="c-standard-parallelism"><a href="https://www.youtube.com/watch?v=LW_T2RGXego" rel="external nofollow noopener" target="_blank">C++ Standard Parallelism</a></h2> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/2023/01/til-6-par-word-count-480.webp 480w,/assets/img/blog/2023/01/til-6-par-word-count-800.webp 800w,/assets/img/blog/2023/01/til-6-par-word-count-1400.webp 1400w," sizes="(max-width: 600px) 100vw, (max-width: 1200px) 80vw, 66vw" type="image/webp"></source> <img src="/assets/img/blog/2023/01/til-6-par-word-count.png" width="100%" height="auto" loading="lazy"> </picture> </figure> <p>It reminds me of certain ways to implement an efficient <code class="language-plaintext highlighter-rouge">wc</code>. Given a <code class="language-plaintext highlighter-rouge">std::string content</code>,</p> <ul> <li>to count the number of chars, simply call <code class="language-plaintext highlighter-rouge">content.size()</code>;</li> <li>to count the number of words, use the algorithm above;</li> <li>to count the number of lines, use <code class="language-plaintext highlighter-rouge">std::count</code> with <code class="language-plaintext highlighter-rouge">par_unseq</code> </li> </ul> <p>My mental model for</p> <ul> <li> <code class="language-plaintext highlighter-rouge">seq</code>: normal sequential program</li> <li> <code class="language-plaintext highlighter-rouge">unseq</code>: SIMD instructions</li> <li> <code class="language-plaintext highlighter-rouge">par</code>: multithreading</li> <li> <code class="language-plaintext highlighter-rouge">par_unseq</code>: multithreading with SIMD instructions</li> </ul> <h2 id="empty-base-optimization"><a href="https://en.cppreference.com/w/cpp/language/ebo" rel="external nofollow noopener" target="_blank">Empty Base Optimization</a></h2> <p>Why Empty class requires to have one byte? It’s worth remembering that in C++, “the addresses of distinct objects of the same type are always distinct”.</p> <ul> <li>At first glance, it makes no sense that we can have two objects of the same type that are in the same address.</li> <li>But this rule is relaxed in C++20 to further promote EBO</li> </ul> <p>When can we apply <code class="language-plaintext highlighter-rouge">[[no_unique_address]]</code>? We use it typically when we need to put some empty class inside some classes.</p> <p>EBO application: <code class="language-plaintext highlighter-rouge">std::pair</code> (reduce the size of the pair), any allocator-awarded container (avoid some extra bytes caused by the storage of the allocator).</p> <p>A corner case of EBO:</p> <blockquote> <p>Empty base optimization is prohibited if one of the empty base classes is also the type or the base of the type of the first non-static data member, since the two base subobjects of the same type are required to have different addresses within the object representation of the most derived type.</p> </blockquote> <h2 id="trivia">Trivia</h2> <ul> <li>Discussions about <code class="language-plaintext highlighter-rouge">TCP_NODELAY</code> <ul> <li><a href="https://withinboredom.info/blog/2022/12/29/golang-is-evil-on-shitty-networks/" rel="external nofollow noopener" target="_blank">Golang is evil on shitty networks</a></li> <li><a href="http://rachelbythebay.com/w/2023/01/05/syscall/" rel="external nofollow noopener" target="_blank">Spammy syscalls in strace dumps</a></li> </ul> </li> <li>Pipe mechanism <ul> <li><a href="https://unix.stackexchange.com/questions/409827/pipeline-as-parallel-command" rel="external nofollow noopener" target="_blank">Pipeline as parallel command</a></li> <li>When the second application (receiver) exits while the first application (sender) still writes to the pipe, we get broken pipe (SIGPIPE)</li> <li><a href="https://unix.stackexchange.com/questions/84813/what-makes-a-unix-process-die-with-broken-pipe" rel="external nofollow noopener" target="_blank">A typical example of SIGPIPE</a></li> </ul> </li> <li>Recursive Lambda in C++ <ul> <li><a href="https://youtu.be/Wg1f9Sufyic?t=3145" rel="external nofollow noopener" target="_blank">The Surprising Costs of void() (and Other Not-Quite-Innocuous Evils)</a></li> <li>We cannot capture lambda itself when creating the lambda. Neither by value or by reference will work. By value definitely cannot work due to recursive definition. By reference has the potential to work, but as we cannot during the type of the lambda when capturing it, it doesn’t work.</li> <li>There are two solutions to build a recursive lambda. The first one is to take another <code class="language-plaintext highlighter-rouge">auto</code> parameter which we will use to accept lambda. The second one is to use declare a variable with type <code class="language-plaintext highlighter-rouge">std::function</code>, which allows us to capture this variable when declaring lambda (as shown in video). However, we need to take care of its lifetime as we are capturing by reference here.</li> </ul> </li> <li> <a href="https://stackoverflow.com/questions/92396/why-cant-variables-be-declared-in-a-switch-statement" rel="external nofollow noopener" target="_blank">Why can’t variables be declared in a switch statement?</a> <ul> <li>Cases are just labels. (That’s why we could have tricks like Duff’s device).</li> <li>The best way to deal with them is to treat them as labels (like those in jump). We could avoid the uninitialization errors by using a <code class="language-plaintext highlighter-rouge">{}</code> bracket in each case (therefore, each case is not in the same scope).</li> </ul> </li> <li>Rust reference <ul> <li><a href="https://users.rust-lang.org/t/reference-to-a-reference/44753/2" rel="external nofollow noopener" target="_blank">Reference to a reference in Rust</a></li> <li> <a href="https://doc.rust-lang.org/std/ops/trait.Deref.html" rel="external nofollow noopener" target="_blank">Deref trait and Deref coercion</a>. If we are passing reference of references, it will be automatically coerced.</li> <li><a href="https://doc.rust-lang.org/std/ops/trait.Index.html" rel="external nofollow noopener" target="_blank">Index trait and <span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow></mrow><annotation encoding="application/x-tex"></annotation></semantics></math></span><span class="katex-html" aria-hidden="true"></span></span></span></a></li> </ul> </li> <li>The Blank Sheet <ul> <li><a href="https://fs.blog/reading/" rel="external nofollow noopener" target="_blank">Reading Better: Retaining and Applying What You Read</a></li> <li>Active reading.</li> </ul> </li> <li>Inline namespace <ul> <li><a href="https://www.youtube.com/watch?v=rUESOjhvLw0" rel="external nofollow noopener" target="_blank">C++ Weekly - Ep 320 - Using <code class="language-plaintext highlighter-rouge">inline namespace</code> To Save Your ABI</a></li> <li>How the object file is linked when we apply <code class="language-plaintext highlighter-rouge">inline namespace</code>: a call to <code class="language-plaintext highlighter-rouge">A::f</code> is linked to <code class="language-plaintext highlighter-rouge">A::inline_namespace_name::f</code> </li> <li>Therefore, we could use different inline namespace names for different versions of our library. As a result of that, the ABI break will actually cause linker errors.</li> </ul> </li> <li> <a href="https://stackoverflow.com/questions/31101854/order-of-destruction-for-stack-heap-allocated-arrays" rel="external nofollow noopener" target="_blank">Order of destruction for stack/heap allocated arrays</a> <ul> <li>The array elements will be destructed in reverse order of construction, with element 99 being the first destructed, then element 98, 97, 96… etc. and element 0 being the last.</li> <li>It’s reasonable once you think about how we declare variables in program order like this: <code class="language-plaintext highlighter-rouge">A a; B b; C c;</code>. The construction order is A, B, C, and the destruction order is C, B, A. This corresponds to how the array is constructed/destructed.</li> </ul> </li> </ul> </div> </article> </div> </main> <footer class="sticky-bottom" role="contentinfo"> <div class="post-version"> © 2025 <a href="/">Yuxiang Qiu</a> <br> v25-02-18 | <a href="https://github.com/yuxqiu/yuxqiu.github.io/commit/164661fe14bea1e047a15eeaa5ed3429c0d08a3e" rel="external nofollow noopener" target="_blank">164661f</a> </div> </footer> </body> </html>