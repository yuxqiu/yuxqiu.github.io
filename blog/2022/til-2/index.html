<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta name="view-transition" content="same-origin"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="author" content="Yuxiang Qiu"> <title>TIL-2: C++ Best Practices, Initializer List, Extern Template | Yuxiang Qiu</title> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="TIL-2: C++ Best Practices, Initializer List, Extern Template"> <meta property="og:locale" content="en"> <meta name="description" content="Compiler Warnings"> <meta property="og:description" content="Compiler Warnings"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2022/til-2/"> <meta property="og:url" content="https://yuxqiu.github.io/blog/2022/til-2/"> <meta property="og:site_name" content="Yuxiang Qiu"> <meta property="og:image" content="https://yuxqiu.github.io/assets/img/og/posts/til-2.png"> <meta property="og:image:height" content="600"> <meta property="og:image:width" content="1200"> <meta property="og:image:alt" content="TIL-2: C++ Best Practices, Initializer List, Extern Template"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2022-11-16T21:27:32+00:00"> <meta name="twitter:card" content="summary_large_image"> <meta property="twitter:image" content="https://yuxqiu.github.io/assets/img/og/posts/til-2.png"> <meta name="twitter:image:alt" content="TIL-2: C++ Best Practices, Initializer List, Extern Template"> <meta property="twitter:title" content="TIL-2: C++ Best Practices, Initializer List, Extern Template"> <meta name="twitter:site" content="@yuxqiu"> <meta name="google-site-verification" content="OyP7PF7v8xjEbPqbdYaMosljunIcAOjdw_C6-TtA8f0"> <meta name="msvalidate.01" content="231286930EDC7A744F88D1D05B1BD04A"> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-05-19T15:54:21+00:00","datePublished":"2022-11-16T21:27:32+00:00","description":"Compiler Warnings","headline":"TIL-2: C++ Best Practices, Initializer List, Extern Template","image":{"width":1200,"height":600,"alt":"TIL-2: C++ Best Practices, Initializer List, Extern Template","url":"https://yuxqiu.github.io/assets/img/og/posts/til-2.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yuxqiu.github.io/blog/2022/til-2/"},"url":"https://yuxqiu.github.io/blog/2022/til-2/"}</script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="/assets/css/mdb.min.css?62a43d1430ddb46fc4886f9d0e3b49b8"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2022/til-2/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class=" "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yuxiang Qiu </a> <input type="checkbox" id="navbar-toggler-checkbox" class="navbar-toggler-checkbox" hidden> <label for="navbar-toggler-checkbox" class="navbar-toggler ml-auto"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </label> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/ss/index.html">SS </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <svg id="light-toggle-system" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9.173 14.83a4 4 0 1 1 5.657 -5.657"></path><path d="M11.294 12.707l.174 .247a7.5 7.5 0 0 0 8.845 2.492a9 9 0 0 1 -14.671 2.914"></path><path d="M3 12h1"></path><path d="M12 3v1"></path><path d="M5.6 5.6l.7 .7"></path><path d="M3 21l18 -18"></path></svg> <svg id="light-toggle-dark" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341 -.82 -.476 -1.644 -1.298 -1.31a6.5 6.5 0 0 1 -6.864 -10.787l.077 -.08c.551 -.63 .113 -1.653 -.758 -1.653h-.266l-.068 -.006l-.06 -.002z"></path></svg> <svg id="light-toggle-light" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 19a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M18.313 16.91l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.218 -1.567l.102 .07z"></path><path d="M7.007 16.993a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M6.213 4.81l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.217 -1.567l.102 .07z"></path><path d="M19.107 4.893a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M12 7a5 5 0 1 1 -4.995 5.217l-.005 -.217l.005 -.217a5 5 0 0 1 4.995 -4.783z"></path></svg> </button> </li> </ul> </div> </div> </nav> </header> <main class="container mt-5 flex-grow-1" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">TIL-2: C++ Best Practices, Initializer List, Extern Template</h1> </header> <article class="post-content"> <hr> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#compiler-warnings">Compiler Warnings</a></li> <li class="toc-entry toc-h2"><a href="#range-based-for-loop">Range-based for loop</a></li> <li class="toc-entry toc-h2"><a href="#template">Template</a></li> <li class="toc-entry toc-h2"><a href="#inheritance">Inheritance</a></li> <li class="toc-entry toc-h2"><a href="#undefined-behavior">Undefined Behavior</a></li> <li class="toc-entry toc-h2"><a href="#switch">switch</a></li> <li class="toc-entry toc-h2"><a href="#const-everywhere">const everywhere</a></li> <li class="toc-entry toc-h2"><a href="#exception-handling">Exception Handling</a></li> <li class="toc-entry toc-h2"><a href="#make-your-interface-hard-to-use-incorrectly">Make your interface hard to use incorrectly</a></li> <li class="toc-entry toc-h2"><a href="#dont-use-initializer_list-for-non-trivial-types">Don’t Use initializer_list For Non-Trivial Types</a></li> <li class="toc-entry toc-h2"><a href="#extern-template">Extern Template</a></li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="compiler-warnings">Compiler Warnings</h2> <ol> <li>Something I don’t know about: <code class="language-plaintext highlighter-rouge">Wpedantic</code> disables language extension <ol> <li>which is good</li> </ol> </li> </ol> <h2 id="range-based-for-loop">Range-based for loop</h2> <ol> <li> <code class="language-plaintext highlighter-rouge">const auto &amp;</code> in most cases</li> <li> <code class="language-plaintext highlighter-rouge">auto &amp;</code> if you need to modify the element inside the container</li> <li> <code class="language-plaintext highlighter-rouge">auto &amp;&amp;</code> if moving elements out of the container</li> </ol> <h2 id="template">Template</h2> <ol> <li>Don’t use <code class="language-plaintext highlighter-rouge">Type T</code> for template. Use some meaningful names (like <code class="language-plaintext highlighter-rouge">BinaryPred</code>, <code class="language-plaintext highlighter-rouge">UnaryPred</code>)</li> </ol> <h2 id="inheritance">Inheritance</h2> <ol> <li>In most cases, delete 4 special members (except constructor, destructor) when you use inheritance because it’s hard to define a correct copy/move constructor and assignment <ol> <li>If there is no slicing issue, you could try default them</li> </ol> </li> </ol> <h2 id="undefined-behavior">Undefined Behavior</h2> <ol> <li>Compilers are allowed to assume no undefined behavior happens in your code <ol> <li>So, sometimes, your code will be optimized out because of this reason</li> <li>In case this happens, it really means you are relying on UB</li> </ol> </li> <li>Checking <code class="language-plaintext highlighter-rouge">reference == nullptr</code> is undefined behavior</li> <li>Dereferencing nullptr is also undefined behavior</li> </ol> <h2 id="switch">switch</h2> <ol> <li>Don’t use <code class="language-plaintext highlighter-rouge">default</code> in <code class="language-plaintext highlighter-rouge">switch</code> <ol> <li>We are talking about using switch with enum</li> <li>This rule applies to C</li> <li>Because if we add new options, default will disable us to get warning about the missing cases</li> </ol> </li> </ol> <h2 id="const-everywhere">const everywhere</h2> <ol> <li> <code class="language-plaintext highlighter-rouge">const</code> as much as you can as soon as it doesn’t affect implicit move</li> <li> <p>If you need to modify code, you can use immediately-invoked lambda<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></p> <div class="language-c++ highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> <span class="k">const</span> <span class="k">auto</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">()</span> <span class="p">{</span>
     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
     <span class="c1">// modification here</span>
     <span class="c1">// NRVO (very likely)</span>
     <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
 <span class="p">}();</span>
</code></pre></div> </div> </li> </ol> <h2 id="exception-handling">Exception Handling</h2> <blockquote> <p><a href="http://cppsecrets.blogspot.com/2013/12/using-lippincott-function-for.html" rel="external nofollow noopener" target="_blank">Using a Lippincott Function for Centralized Exception Handling</a></p> </blockquote> <ol> <li>Lippincott exception handling <ol> <li>A centralized way to deal with exception</li> </ol> </li> <li>Basically, catch all the exception with <code class="language-plaintext highlighter-rouge">catch(...)</code> <ol> <li>Inside the catch block, call <code class="language-plaintext highlighter-rouge">lippincott</code> </li> </ol> </li> <li>This <code class="language-plaintext highlighter-rouge">lippincott</code> function tries to rethrow the error with <code class="language-plaintext highlighter-rouge">throw;</code> inside a try block with many possible catches <ol> <li>If any of them matches, we process that particular exception</li> <li>If this function is called without any exception, <code class="language-plaintext highlighter-rouge">std::terminate</code> is called</li> </ol> </li> </ol> <h2 id="make-your-interface-hard-to-use-incorrectly">Make your interface hard to use incorrectly</h2> <blockquote> <p>Effective C++ item 18: Make interfaces easy to use correctly and hard to use incorrectly</p> </blockquote> <ol> <li>Even though your data might be easy (just a int or bool or …), it’s still necessary for you to create a wrapper for it to tell people explicitly what’s the meaning of the code. <ol> <li>Then, it’s hard for people to use your interface incorrectly</li> </ol> </li> <li>Any function or overload can be <code class="language-plaintext highlighter-rouge">=deleted</code> in C++11 <ol> <li>This disables people pass parameters that could implicitly convert to our specified types unexpectedly. For example, if we want to accept double and reject float, we delete the overload for float.</li> </ol> </li> </ol> <h2 id="dont-use-initializer_list-for-non-trivial-types">Don’t Use initializer_list For Non-Trivial Types</h2> <blockquote> <p>Talk: <a href="https://www.youtube.com/watch?v=sSlmmZMFsXQ" rel="external nofollow noopener" target="_blank">C++Now 2018: Jason Turner “Initializer Lists Are Broken, Let’s Fix Them”</a></p> <p>Slide: <a href="https://github.com/boostcon/cppnow_presentations_2018/blob/master/05-09-2018_wednesday/initializer_lists_are_broken__jason_turner__cppnow_05092018.pdf" rel="external nofollow noopener" target="_blank">initializer_lists Are Broken, Let’s Fix Them</a></p> </blockquote> <ol> <li> <code class="language-plaintext highlighter-rouge">std::initializer_lists&lt;T&gt;</code> is like a view instead of a concrete container that actually controls the lifetime of the object <ol> <li>It’s a pointer to an local array</li> <li>“An object of type <code class="language-plaintext highlighter-rouge">std::initializer_list&lt;E&gt;</code> is constructed from an initializer list as if the implementation generated and materialized a prvalue of type “array of N const E”, where N is the number of elements in the initializer list. Each element of that array is copy initialized with the corresponding element of the initializer list, and the <code class="language-plaintext highlighter-rouge">std::initializer_list&lt;E&gt;</code> object is constructed to refer to that array”</li> <li>So, returning an initializer_list from a function is like returning a pointer to a local object</li> </ol> </li> <li>Because the generated array is const, we can only use copy constructor when using initializer_list <ol> <li>This causes us fail to construct a vector of unique_ptr via initializer_list</li> <li> <p>But, we can still construct an array via initializer list because this is aggregate initialization instead of initializer_list</p> <div class="language-c++ highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> <span class="k">struct</span> <span class="nc">X</span> <span class="p">{</span>
     <span class="n">X</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">initializer_list</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">);</span>
 <span class="p">};</span>
 <span class="n">X</span> <span class="n">x</span><span class="p">{</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="p">};</span>

 <span class="c1">// is equivalent to</span>
 <span class="k">const</span> <span class="kt">double</span> <span class="n">__a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="kt">double</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span> <span class="kt">double</span><span class="p">{</span><span class="mi">2</span><span class="p">},</span> <span class="kt">double</span><span class="p">{</span><span class="mi">3</span><span class="p">}};</span>
 <span class="n">X</span> <span class="nf">x</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">initializer_list</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">__a</span><span class="p">,</span> <span class="n">__a</span><span class="o">+</span><span class="mi">3</span><span class="p">));</span>
</code></pre></div> </div> </li> <li>No narrowing conversions allowed because we are initializing the member via <code class="language-plaintext highlighter-rouge">{}</code> </li> </ol> </li> <li>Possible Improvements <ol> <li>A non-const array with movable iterator <ol> <li>check <code class="language-plaintext highlighter-rouge">std::make_move_iterator</code> </li> </ol> </li> <li>Construct in-place by inheriting from vector</li> </ol> </li> <li>Interesting Observations <ol> <li>Compilers may not have the ability to track the size of <code class="language-plaintext highlighter-rouge">const char *</code>. To have a higher probability of doing SSO, construct the string directly when trying to return <code class="language-plaintext highlighter-rouge">const char *</code> from functions and later try to construct a string with this <code class="language-plaintext highlighter-rouge">const char *</code> </li> </ol> </li> <li> <code class="language-plaintext highlighter-rouge">std::in_place_t</code> <ol> <li>A tag used by <code class="language-plaintext highlighter-rouge">variant</code>, <code class="language-plaintext highlighter-rouge">optional</code> and <code class="language-plaintext highlighter-rouge">any</code> so that we can default construct the actual object in-place. These types could be non-movable/non-copyable.</li> <li> <code class="language-plaintext highlighter-rouge">std::make_optional</code>, <code class="language-plaintext highlighter-rouge">std::make_any</code>, <code class="language-plaintext highlighter-rouge">std::in_place</code> (the global value that has type <code class="language-plaintext highlighter-rouge">std::in_place_t</code>), <code class="language-plaintext highlighter-rouge">std::in_place_type&lt;T&gt;</code> (useful when trying to decide which type in variant to init), <code class="language-plaintext highlighter-rouge">std::in_place_index&lt;val&gt;</code> (specify which index to create/set)</li> <li>See <a href="https://www.cppstories.com/2018/07/in-place-cpp17/" rel="external nofollow noopener" target="_blank">this article</a> for more details</li> </ol> </li> </ol> <h2 id="extern-template">Extern Template</h2> <blockquote> <p><a href="https://arne-mertz.de/2019/02/extern-template-reduce-compile-times/" rel="external nofollow noopener" target="_blank">Reduce Compilation Times With extern template</a></p> </blockquote> <ol> <li>If we use one template with a specific type frequently, extern template can help us solve the time to instantiate the template in each translational unit <ol> <li>In the normal process, template is initialized in every translational unit if it’s used and during link time, only one instantiation will be kept.</li> </ol> </li> <li>By using <code class="language-plaintext highlighter-rouge">extern template void Fun&lt;T&gt;();</code>, we signify that we have a template already instantiated. <ol> <li>Put this declaration in header file to make sure when we compile this code with <code class="language-plaintext highlighter-rouge">-O3</code>, the instantiated template is not inlined.</li> </ol> </li> </ol> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p>You can check Jason Turner’s channel <a href="https://www.youtube.com/watch?v=d4nmNYTM1j8" rel="external nofollow noopener" target="_blank">C++ Weekly - Ep 70 - C++ IIFE in quick-bench.com</a> for more information about IIFE (immediately-invoked function expression) <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> </div> </main> <footer class="sticky-bottom" role="contentinfo"> <div class="post-version"> © 2025 <a href="/">Yuxiang Qiu</a> <br> v25-05-19 | <a href="https://github.com/yuxqiu/yuxqiu.github.io/commit/4cbc917ef1fbb3948e92bb1c563a4d7126a17b4d" rel="external nofollow noopener" target="_blank">4cbc917</a> </div> </footer> </body> </html>