<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta name="view-transition" content="same-origin"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="author" content="Yuxiang Qiu"> <title>TIL-4: Alignment | Yuxiang Qiu</title> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="TIL-4: Alignment"> <meta property="og:locale" content="en"> <meta name="description" content="Alignment and Cache"> <meta property="og:description" content="Alignment and Cache"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2022/til-4/"> <meta property="og:url" content="https://yuxqiu.github.io/blog/2022/til-4/"> <meta property="og:site_name" content="Yuxiang Qiu"> <meta property="og:image" content="https://yuxqiu.github.io/assets/img/og/posts/til-4.png"> <meta property="og:image:height" content="600"> <meta property="og:image:width" content="1200"> <meta property="og:image:alt" content="TIL-4: Alignment"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2022-12-03T14:24:29+00:00"> <meta name="twitter:card" content="summary_large_image"> <meta property="twitter:image" content="https://yuxqiu.github.io/assets/img/og/posts/til-4.png"> <meta name="twitter:image:alt" content="TIL-4: Alignment"> <meta property="twitter:title" content="TIL-4: Alignment"> <meta name="twitter:site" content="@yuxqiu"> <meta name="google-site-verification" content="OyP7PF7v8xjEbPqbdYaMosljunIcAOjdw_C6-TtA8f0"> <meta name="msvalidate.01" content="231286930EDC7A744F88D1D05B1BD04A"> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-05-19T15:54:21+00:00","datePublished":"2022-12-03T14:24:29+00:00","description":"Alignment and Cache","headline":"TIL-4: Alignment","image":{"width":1200,"height":600,"alt":"TIL-4: Alignment","url":"https://yuxqiu.github.io/assets/img/og/posts/til-4.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yuxqiu.github.io/blog/2022/til-4/"},"url":"https://yuxqiu.github.io/blog/2022/til-4/"}</script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2022/til-4/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class=" "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yuxiang Qiu </a> <input type="checkbox" id="navbar-toggler-checkbox" class="navbar-toggler-checkbox" hidden> <label for="navbar-toggler-checkbox" class="navbar-toggler ml-auto"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </label> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/ss/index.html">SS </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <svg id="light-toggle-system" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9.173 14.83a4 4 0 1 1 5.657 -5.657"></path><path d="M11.294 12.707l.174 .247a7.5 7.5 0 0 0 8.845 2.492a9 9 0 0 1 -14.671 2.914"></path><path d="M3 12h1"></path><path d="M12 3v1"></path><path d="M5.6 5.6l.7 .7"></path><path d="M3 21l18 -18"></path></svg> <svg id="light-toggle-dark" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341 -.82 -.476 -1.644 -1.298 -1.31a6.5 6.5 0 0 1 -6.864 -10.787l.077 -.08c.551 -.63 .113 -1.653 -.758 -1.653h-.266l-.068 -.006l-.06 -.002z"></path></svg> <svg id="light-toggle-light" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 19a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M18.313 16.91l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.218 -1.567l.102 .07z"></path><path d="M7.007 16.993a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M6.213 4.81l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.217 -1.567l.102 .07z"></path><path d="M19.107 4.893a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M12 7a5 5 0 1 1 -4.995 5.217l-.005 -.217l.005 -.217a5 5 0 0 1 4.995 -4.783z"></path></svg> </button> </li> </ul> </div> </div> </nav> </header> <main class="container mt-5 flex-grow-1" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">TIL-4: Alignment</h1> </header> <article class="post-content"> <hr> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#alignment-and-cache">Alignment and Cache</a></li> <li class="toc-entry toc-h2"><a href="#trivia">Trivia</a></li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="alignment-and-cache">Alignment and Cache</h2> <ol> <li> <p>Common cache line size is 64 bytes</p> </li> <li> <p>To ensure data in different thread doesn’t interfere with other due to the requirement of cache consistency, we need to make sure they operate on data that is on different cache lines</p> </li> <li>C++ provides us with keyword <code class="language-plaintext highlighter-rouge">alignas</code> <ol> <li> <code class="language-plaintext highlighter-rouge">alignas</code> can be used to 1) the declaration or definition of a class; 2) the declaration of a non-bitfield class data member; 3) the declaration of a variable, except that it cannot be applied to the following: a function parameter; the exception parameter of a catch clause.</li> <li>Example: <code class="language-plaintext highlighter-rouge">struct alignas(32) sse_t { ... };</code> or <code class="language-plaintext highlighter-rouge">alignas(64) int x;</code> or <code class="language-plaintext highlighter-rouge">int alignas(64) x;</code> </li> </ol> </li> <li>C++ also provide <code class="language-plaintext highlighter-rouge">hardware_destructive_interference_size</code> and <code class="language-plaintext highlighter-rouge">hardware_constructive_interference_size</code> in <code class="language-plaintext highlighter-rouge">&lt;new&gt;</code>. According to cppreference, “these constants provide a portable way to access the L1 data cache line size.”<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> <ol> <li> <code class="language-plaintext highlighter-rouge">hardware_destructive_interference_size</code> defines “minimum offset between two objects to avoid false sharing.”</li> <li> <p><code class="language-plaintext highlighter-rouge">hardware_constructive_interference_size</code> defines “maximum size of contiguous memory to promote true sharing.”</p> <div class="language-c++ highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>  <span class="c1">// occupies one cache line</span>
  <span class="k">struct</span> <span class="nc">alignas</span><span class="p">(</span><span class="n">hardware_constructive_interference_size</span><span class="p">)</span> <span class="n">OneCacheLiner</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">atomic_uint64_t</span> <span class="n">x</span><span class="p">{};</span>
      <span class="n">std</span><span class="o">::</span><span class="n">atomic_uint64_t</span> <span class="n">y</span><span class="p">{};</span>
  <span class="p">};</span>

  <span class="c1">// occupies two cache lines</span>
  <span class="k">struct</span> <span class="nc">TwoCacheLiner</span> <span class="p">{</span>
      <span class="k">alignas</span><span class="p">(</span><span class="n">hardware_destructive_interference_size</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">atomic_uint64_t</span> <span class="n">x</span><span class="p">{};</span>
      <span class="k">alignas</span><span class="p">(</span><span class="n">hardware_destructive_interference_size</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">atomic_uint64_t</span> <span class="n">y</span><span class="p">{};</span>
  <span class="p">}</span> <span class="n">twoCacheLiner</span><span class="p">;</span>
</code></pre></div> </div> </li> </ol> </li> <li>What exactly is <a href="https://en.cppreference.com/w/cpp/language/object#Alignment" rel="external nofollow noopener" target="_blank">alignment</a>? <ol> <li>“The number of bytes between successive addresses at which objects of this type can be allocated”</li> <li>“Each object type imposes its alignment requirement on every object of that type;”</li> <li>“The largest fundamental alignment of any type is implementation-defined and equal to the alignment of <code class="language-plaintext highlighter-rouge">std::max_align_t</code>” (which is the size of <code class="language-plaintext highlighter-rouge">long double</code> 16 bytes)</li> </ol> </li> <li> <code class="language-plaintext highlighter-rouge">alignof</code> <ol> <li>Like <code class="language-plaintext highlighter-rouge">sizeof</code>, but returned the alignment of the object</li> </ol> </li> </ol> <h2 id="trivia">Trivia</h2> <ol> <li> <p>Shell command starts with spaces can hide this command from history</p> </li> <li>A simplified evaluation order of shell (This is derived from one of our recent projects: Develop a Shell in Java) <ol> <li>Command substitution is performed (see command substitution);</li> <li>The command is split into arguments based on whitespaces</li> <li>Globbing is performed</li> <li>The application is called</li> </ol> </li> <li>Commonly used shortcuts for oh-my-zsh <code class="language-plaintext highlighter-rouge">git</code> plugin <ol> <li><a href="https://kapeli.com/cheat_sheets/Oh-My-Zsh_Git.docset/Contents/Resources/Documents/index" rel="external nofollow noopener" target="_blank">Cheatsheet</a></li> <li> <code class="language-plaintext highlighter-rouge">ga = git add</code>, <code class="language-plaintext highlighter-rouge">gaa = git add -all</code> </li> <li> <code class="language-plaintext highlighter-rouge">gb = git branch</code>, <code class="language-plaintext highlighter-rouge">gbd = git branch -d</code>, <code class="language-plaintext highlighter-rouge">gbD = git branch -D</code> </li> <li> <code class="language-plaintext highlighter-rouge">gcb = git checkout -b</code>, <code class="language-plaintext highlighter-rouge">gco = git checkout</code>, <code class="language-plaintext highlighter-rouge">gd = git diff</code> </li> <li> <code class="language-plaintext highlighter-rouge">gf = git fetch</code>, <code class="language-plaintext highlighter-rouge">gfo = git fetch origin</code> </li> <li><code class="language-plaintext highlighter-rouge">gl = git pull</code></li> <li> <code class="language-plaintext highlighter-rouge">gp = git push</code>, <code class="language-plaintext highlighter-rouge">gpf = git push --force-with-lease</code>, <code class="language-plaintext highlighter-rouge">gpf! = git push --force</code> </li> <li><code class="language-plaintext highlighter-rouge">gm = git merge</code></li> <li> <code class="language-plaintext highlighter-rouge">gr = git remote</code>, <code class="language-plaintext highlighter-rouge">gra = git remote add</code> </li> <li> <code class="language-plaintext highlighter-rouge">grb = git rebase</code>, <code class="language-plaintext highlighter-rouge">grba = git rebase --abort</code>, <code class="language-plaintext highlighter-rouge">grbc = git rebase --continue</code>, <code class="language-plaintext highlighter-rouge">grbi = git rebase -i</code> </li> </ol> </li> <li> <p><code class="language-plaintext highlighter-rouge">git reset</code> different levels (<code class="language-plaintext highlighter-rouge">soft</code>, <code class="language-plaintext highlighter-rouge">mixed</code>, <code class="language-plaintext highlighter-rouge">hard</code>)<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup></p> </li> <li> <code class="language-plaintext highlighter-rouge">time</code> command<sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup> <ol> <li>Real is wall clock time - time from start to finish of the call. This is all elapsed time including time slices used by other processes and time the process spends blocked (for example if it is waiting for I/O to complete).</li> <li>User is the amount of CPU time spent in user-mode code (outside the kernel) within the process. This is only actual CPU time used in executing the process. Other processes and time the process spends blocked do not count towards this figure.</li> <li>Sys is the amount of CPU time spent in the kernel within the process. This means executing CPU time spent in system calls within the kernel, as opposed to library code, which is still running in user-space. Like ‘user’, this is only CPU time used by the process.</li> </ol> </li> </ol> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p><a href="https://en.cppreference.com/w/cpp/thread/hardware_destructive_interference_size" rel="external nofollow noopener" target="_blank">cppreference std::hardware_destructive_interference_size, std::hardware_constructive_interference_size</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2"> <p><a href="https://stackoverflow.com/a/3528483" rel="external nofollow noopener" target="_blank">mkarasek’s answer: What’s the difference between git reset --mixed, --soft, and --hard?</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:3"> <p><a href="http://zch051383471952.blogspot.com/2010/01/different-of-real-user-sys-time.html" rel="external nofollow noopener" target="_blank">DIFFERENT OF REAL USER SYS TIME</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> </div> </main> <footer class="sticky-bottom" role="contentinfo"> <div class="post-version"> © 2025 <a href="/">Yuxiang Qiu</a> <br> v25-05-19 | <a href="https://github.com/yuxqiu/yuxqiu.github.io/commit/4cbc917ef1fbb3948e92bb1c563a4d7126a17b4d" rel="external nofollow noopener" target="_blank">4cbc917</a> </div> </footer> </body> </html>