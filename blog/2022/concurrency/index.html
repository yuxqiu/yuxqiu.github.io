<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="author" content="Yuxiang Qiu"> <title>Concurrency | Yuxiang Qiu</title> <meta name="generator" content="Jekyll v4.4.1"> <meta property="og:title" content="Concurrency"> <meta property="og:locale" content="en"> <meta name="description" content="Java Memory Model"> <meta property="og:description" content="Java Memory Model"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2022/concurrency/"> <meta property="og:url" content="https://yuxqiu.github.io/blog/2022/concurrency/"> <meta property="og:site_name" content="Yuxiang Qiu"> <meta property="og:image" content="https://yuxqiu.github.io/assets/img/og/posts/concurrency.png"> <meta property="og:image:height" content="600"> <meta property="og:image:width" content="1200"> <meta property="og:image:alt" content="Concurrency"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2022-12-08T20:39:06+00:00"> <meta name="twitter:card" content="summary_large_image"> <meta property="twitter:image" content="https://yuxqiu.github.io/assets/img/og/posts/concurrency.png"> <meta name="twitter:image:alt" content="Concurrency"> <meta property="twitter:title" content="Concurrency"> <meta name="twitter:site" content="@yuxqiu"> <meta name="google-site-verification" content="OyP7PF7v8xjEbPqbdYaMosljunIcAOjdw_C6-TtA8f0"> <meta name="msvalidate.01" content="231286930EDC7A744F88D1D05B1BD04A"> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-02-18T14:33:14+00:00","datePublished":"2022-12-08T20:39:06+00:00","description":"Java Memory Model","headline":"Concurrency","image":{"width":1200,"height":600,"alt":"Concurrency","url":"https://yuxqiu.github.io/assets/img/og/posts/concurrency.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yuxqiu.github.io/blog/2022/concurrency/"},"url":"https://yuxqiu.github.io/blog/2022/concurrency/"}</script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://yuxqiu.github.io/blog/2022/concurrency/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class=" "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yuxiang Qiu </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <svg id="light-toggle-system" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9.173 14.83a4 4 0 1 1 5.657 -5.657"></path><path d="M11.294 12.707l.174 .247a7.5 7.5 0 0 0 8.845 2.492a9 9 0 0 1 -14.671 2.914"></path><path d="M3 12h1"></path><path d="M12 3v1"></path><path d="M5.6 5.6l.7 .7"></path><path d="M3 21l18 -18"></path></svg> <svg id="light-toggle-dark" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341 -.82 -.476 -1.644 -1.298 -1.31a6.5 6.5 0 0 1 -6.864 -10.787l.077 -.08c.551 -.63 .113 -1.653 -.758 -1.653h-.266l-.068 -.006l-.06 -.002z"></path></svg> <svg id="light-toggle-light" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 19a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M18.313 16.91l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.218 -1.567l.102 .07z"></path><path d="M7.007 16.993a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M4 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M21 11a1 1 0 0 1 .117 1.993l-.117 .007h-1a1 1 0 0 1 -.117 -1.993l.117 -.007h1z"></path><path d="M6.213 4.81l.094 .083l.7 .7a1 1 0 0 1 -1.32 1.497l-.094 -.083l-.7 -.7a1 1 0 0 1 1.217 -1.567l.102 .07z"></path><path d="M19.107 4.893a1 1 0 0 1 .083 1.32l-.083 .094l-.7 .7a1 1 0 0 1 -1.497 -1.32l.083 -.094l.7 -.7a1 1 0 0 1 1.414 0z"></path><path d="M12 2a1 1 0 0 1 .993 .883l.007 .117v1a1 1 0 0 1 -1.993 .117l-.007 -.117v-1a1 1 0 0 1 1 -1z"></path><path d="M12 7a5 5 0 1 1 -4.995 5.217l-.005 -.217l.005 -.217a5 5 0 0 1 4.995 -4.783z"></path></svg> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Concurrency</h1> </header> <article class="post-content"> <hr> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"> <a href="#java-memory-model">Java Memory Model</a> <ul> <li class="toc-entry toc-h3"><a href="#immutable-object-and-safe-publishing">Immutable Object and Safe Publishing</a></li> </ul> </li> <li class="toc-entry toc-h2"><a href="#reordering-java-and-c">Reordering (Java and C++)</a></li> <li class="toc-entry toc-h2"> <a href="#execution">Execution</a> <ul> <li class="toc-entry toc-h3"><a href="#execution-within-one-thread">Execution within one thread</a></li> <li class="toc-entry toc-h3"><a href="#execution-with-multiple-threads">Execution with multiple threads</a></li> </ul> </li> <li class="toc-entry toc-h2"><a href="#more-resources">More resources</a></li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="java-memory-model">Java Memory Model</h2> <p>For an object to be safely shared across different threads (visibility), it needs to be</p> <ul> <li>immutable, which JVM guarantees all the fields initialized before constructor exits</li> <li>effective immutable + safely published</li> <li>mutable + safely published + synchronization mechanism</li> </ul> <h3 id="immutable-object-and-safe-publishing">Immutable Object and Safe Publishing</h3> <ol> <li> <p>Immutable = all the fields are marked with <code class="language-plaintext highlighter-rouge">final</code></p> </li> <li> <p>Safely published means</p> <ol> <li>The object is statically initialized</li> <li>The reference of the object is put into <code class="language-plaintext highlighter-rouge">final</code> </li> <li>The reference of the object is put into <code class="language-plaintext highlighter-rouge">volatile</code>: all the writes to the object directly writes to the memory instead of staying in cache</li> <li>Storing a reference to it into a field that is properly guarded by a lock</li> </ol> </li> </ol> <h2 id="reordering-java-and-c">Reordering (Java and C++)</h2> <ol> <li>Instruction reordering is a useful technique for Instruction Level Parallelism. However, it causes problems when we are sharing multiple variables during concurrency. <ol> <li> <p>The classic example is shown below:</p> <div class="language-java highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>  <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="kt">void</span> <span class="nf">thread1</span><span class="o">(){</span>
      <span class="n">val</span> <span class="o">=</span> <span class="mi">42</span><span class="o">;</span>
      <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kt">void</span> <span class="nf">thread2</span><span class="o">(){</span>
      <span class="k">while</span><span class="o">(!</span><span class="n">flag</span><span class="o">){}</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div> </div> </li> <li> <p>It’s possible that the val printed is not equal to 42 because the instruction can be reordered such that flag is set to true before val is set to 42</p> </li> </ol> </li> <li>To address this in Java, we could use <code class="language-plaintext highlighter-rouge">volatile</code> on flag. It gives a “happens-before” guarantee in addition to the visibility guarantee. The happens-before guarantee guarantees that: <sup id="fnref:reordering-1"><a href="#fn:reordering-1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> <ol> <li> <strong>Reads from and writes to other variables</strong> cannot be reordered to occur after a write to a volatile variable, if the reads / writes originally occurred before the write to the volatile variable.</li> <li>The reads / writes before a write to a volatile variable are guaranteed to “happen before” the write to the volatile variable. Notice that it is still possible for e.g. reads / writes of other variables located after a write to a volatile to be reordered to occur before that write to the volatile. Just not the other way around. From after to before is allowed, but from before to after is not allowed.</li> <li> <strong>Reads from and writes to other variables cannot be reordered to occur before a read of a volatile variable</strong>, if the reads / writes originally occurred after the read of the volatile variable. Notice that it is possible for reads of other variables that occur before the read of a volatile variable can be reordered to occur after the read of the volatile. Just not the other way around.</li> </ol> </li> <li>C++’s <code class="language-plaintext highlighter-rouge">volatile</code> is different in terms of its guarantee. It says “volatile accesses cannot be optimized out or reordered with another visible side effect that is sequenced-before or sequenced-after the volatile access.” <sup id="fnref:reordering-2"><a href="#fn:reordering-2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup> <ol> <li><a href="https://en.cppreference.com/w/cpp/language/as_if#Explanation" rel="external nofollow noopener" target="_blank">What is a visible side effect?</a></li> <li><a href="https://en.cppreference.com/w/cpp/language/eval_order#Rules" rel="external nofollow noopener" target="_blank">What is sequenced-before?</a></li> <li>So, consider the Java example in C++ context. We have different possibilities when we apply <code class="language-plaintext highlighter-rouge">volatile</code> to these two variables, see <a href="https://gcc.godbolt.org/z/hYM96r9r6" rel="external nofollow noopener" target="_blank">compiler explorer</a> (Notice, C++ <code class="language-plaintext highlighter-rouge">volatile</code> cannot be used to address the synchronization problem in this example.) <ol> <li>If both variables are non-volatile, they can be reordered</li> <li>If one of them are volatile, they can still be reordered (as the writes to another variable is not a visible side effect)</li> <li>If two of them are volatile, the order must be respected based on sequence-before rules</li> </ol> </li> </ol> </li> </ol> <h2 id="execution">Execution</h2> <h3 id="execution-within-one-thread">Execution within one thread</h3> <ol> <li>Java: “Each action in a thread happens-before every action in that thread that comes later in the program’s order.” <sup id="fnref:execution-1"><a href="#fn:execution-1" class="footnote" rel="footnote" role="doc-noteref">3</a></sup> <ol> <li> <blockquote> <p>It should be noted that the presence of a happens-before relationship between two actions does not necessarily imply that they have to take place in that order in an implementation. If the reordering produces results consistent with a legal execution, it is not illegal. <sup id="fnref:execution-2"><a href="#fn:execution-2" class="footnote" rel="footnote" role="doc-noteref">4</a></sup></p> </blockquote> </li> </ol> </li> <li>C++: “Each value computation and side effect of a full-expression is sequenced before each value computation and side effect of the next full-expression.” <sup id="fnref:execution-3"><a href="#fn:execution-3" class="footnote" rel="footnote" role="doc-noteref">5</a></sup> <ol> <li>as-if rule permits optimization. Those guarantees are the guarantees of C++ Abstract Machine.</li> </ol> </li> </ol> <h3 id="execution-with-multiple-threads">Execution with multiple threads</h3> <ol> <li> <code class="language-plaintext highlighter-rouge">volatile</code> in Java can be used to ensure safe publishing</li> <li> <code class="language-plaintext highlighter-rouge">volatile</code> in C++ <ol> <li> <blockquote> <p>Within a thread of execution, accesses (reads and writes) through volatile glvalues cannot be reordered past observable side-effects (including other volatile accesses) that are sequenced-before or sequenced-after within the same thread, but this order is not guaranteed to be observed by another thread, since volatile access does not establish inter-thread synchronization. <sup id="fnref:execution-4"><a href="#fn:execution-4" class="footnote" rel="footnote" role="doc-noteref">6</a></sup></p> </blockquote> </li> <li>It’s mainly used to deal with signal handling</li> <li>It’s not intended to use for inter-thread communication (sequence-before is used to describe execution within one thread). Inter-thread communication should consider the memory fence or mutex.</li> <li>See <a href="https://wiki.sei.cmu.edu/confluence/display/c/CON02-C.+Do+not+use+volatile+as+a+synchronization+primitive" rel="external nofollow noopener" target="_blank">guarantees not provided by volatile</a> for more details</li> </ol> </li> </ol> <h2 id="more-resources">More resources</h2> <ol> <li><a href="https://stackoverflow.com/questions/51695962/does-object-construction-guarantee-in-practice-that-all-threads-see-non-final-fi" rel="external nofollow noopener" target="_blank">An example of unsafe publishing</a></li> <li><a href="https://stackoverflow.com/questions/16107683/improper-publication-of-java-object-reference" rel="external nofollow noopener" target="_blank">Why unsafe publishing can occur?</a></li> <li><a href="https://stackoverflow.com/questions/4557979/when-to-use-volatile-with-multi-threading" rel="external nofollow noopener" target="_blank">When to use volatile with multi threading?</a></li> </ol> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:reordering-1"> <p><a href="https://jenkov.com/tutorials/java-concurrency/volatile.html" rel="external nofollow noopener" target="_blank">Java Volatile Keyword</a> <a href="#fnref:reordering-1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:reordering-2"> <p><a href="https://en.cppreference.com/w/cpp/language/cv" rel="external nofollow noopener" target="_blank">cv (const and volatile) type qualifiers</a> <a href="#fnref:reordering-2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:execution-1"> <p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html#MemoryVisibility" rel="external nofollow noopener" target="_blank">Package java.util.concurrent: Memory Consistency Properties</a> <a href="#fnref:execution-1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:execution-2"> <p><a href="https://stackoverflow.com/a/32492873" rel="external nofollow noopener" target="_blank">JLS happens before</a> <a href="#fnref:execution-2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:execution-3"> <p><a href="https://en.cppreference.com/w/cpp/language/as_if#Explanation" rel="external nofollow noopener" target="_blank">Order of evaluation: "Sequenced before" rules</a> <a href="#fnref:execution-3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:execution-4"> <p><a href="https://en.cppreference.com/w/cpp/atomic/memory_order#Relationship_with_volatile" rel="external nofollow noopener" target="_blank">std::memory_order: Relationship with volatile</a> <a href="#fnref:execution-4" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> </div> </div> <footer class="sticky-bottom" role="contentinfo"> <div class="post-version"> © 2025 <a href="/">Yuxiang Qiu</a> <br> v25-02-18 | <a href="https://github.com/yuxqiu/yuxqiu.github.io/commit/164661fe14bea1e047a15eeaa5ed3429c0d08a3e" rel="external nofollow noopener" target="_blank">164661f</a> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?2ba90035c86b946ac994fb801fa6ff3c"></script> </body> </html>